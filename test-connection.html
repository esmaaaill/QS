<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connection Test - Quick Stay</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .test-card {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .test-card h3 {
            margin-top: 0;
            color: #333;
        }

        .status {
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
            margin: 5px 0;
        }

        .status.pending {
            background: #ffeaa7;
            color: #d63031;
        }

        .status.success {
            background: #55efc4;
            color: #00b894;
        }

        .status.error {
            background: #ff7675;
            color: #d63031;
        }

        button {
            background: #ff6b2c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #e55a1f;
        }

        pre {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <h1>ðŸ”§ Quick Stay - Connection Test</h1>
    <p>This page tests all backend connections. Make sure you've configured <code>assets/config.js</code> first.</p>

    <div class="test-card">
        <h3>1. Supabase Connection</h3>
        <div id="supabase-status" class="status pending">Not tested</div>
        <button onclick="testSupabase()">Test Supabase</button>
        <pre id="supabase-result"></pre>
    </div>

    <div class="test-card">
        <h3>2. Database Read (Public)</h3>
        <div id="db-status" class="status pending">Not tested</div>
        <button onclick="testDatabase()">Test Database</button>
        <pre id="db-result"></pre>
    </div>

    <div class="test-card">
        <h3>3. Authentication</h3>
        <div id="auth-status" class="status pending">Not tested</div>
        <button onclick="testAuth()">Test Sign Up</button>
        <pre id="auth-result"></pre>
    </div>

    <div class="test-card">
        <h3>4. Edge Functions</h3>
        <div id="functions-status" class="status pending">Not tested</div>
        <button onclick="testFunctions()">Test Functions</button>
        <pre id="functions-result"></pre>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/config.js"></script>
    <script>
        let supabase;

        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('Supabase client initialized');
        } catch (e) {
            document.getElementById('supabase-result').textContent = 'Error: ' + e.message;
            document.getElementById('supabase-status').textContent = 'Failed';
            document.getElementById('supabase-status').className = 'status error';
        }

        async function testSupabase() {
            const statusEl = document.getElementById('supabase-status');
            const resultEl = document.getElementById('supabase-result');

            statusEl.textContent = 'Testing...';
            statusEl.className = 'status pending';

            try {
                if (!supabase) throw new Error('Supabase client not initialized. Check config.js');

                const { data, error } = await supabase.from('profiles').select('count');

                if (error) throw error;

                statusEl.textContent = 'âœ“ Connected';
                statusEl.className = 'status success';
                resultEl.textContent = JSON.stringify({
                    message: 'Supabase connected successfully',
                    url: SUPABASE_URL
                }, null, 2);
            } catch (err) {
                statusEl.textContent = 'âœ— Failed';
                statusEl.className = 'status error';
                resultEl.textContent = 'Error: ' + err.message;
            }
        }

        async function testDatabase() {
            const statusEl = document.getElementById('db-status');
            const resultEl = document.getElementById('db-result');

            statusEl.textContent = 'Testing...';
            statusEl.className = 'status pending';

            try {
                const { data: hotels, error } = await supabase
                    .from('hotels')
                    .select('*')
                    .limit(5);

                if (error) throw error;

                statusEl.textContent = `âœ“ Found ${hotels.length} hotels`;
                statusEl.className = 'status success';
                resultEl.textContent = JSON.stringify(hotels, null, 2);
            } catch (err) {
                statusEl.textContent = 'âœ— Failed';
                statusEl.className = 'status error';
                resultEl.textContent = 'Error: ' + err.message + '\n\nTip: Make sure migrations are pushed (supabase db push)';
            }
        }

        async function testAuth() {
            const statusEl = document.getElementById('auth-status');
            const resultEl = document.getElementById('auth-result');

            statusEl.textContent = 'Testing...';
            statusEl.className = 'status pending';

            try {
                const testEmail = `test${Date.now()}@example.com`;
                const testPassword = 'TestPassword123!';

                const { data, error } = await supabase.auth.signUp({
                    email: testEmail,
                    password: testPassword,
                    options: {
                        data: { full_name: 'Test User' }
                    }
                });

                if (error) throw error;

                statusEl.textContent = 'âœ“ Auth working';
                statusEl.className = 'status success';
                resultEl.textContent = JSON.stringify({
                    message: 'Test user created successfully',
                    email: testEmail,
                    user_id: data.user?.id
                }, null, 2);

                // Clean up - sign out
                await supabase.auth.signOut();
            } catch (err) {
                statusEl.textContent = 'âœ— Failed';
                statusEl.className = 'status error';
                resultEl.textContent = 'Error: ' + err.message;
            }
        }

        async function testFunctions() {
            const statusEl = document.getElementById('functions-status');
            const resultEl = document.getElementById('functions-result');

            statusEl.textContent = 'Testing...';
            statusEl.className = 'status pending';

            try {
                // Test if functions are deployed by checking rooms endpoint
                const { data, error } = await supabase.functions.invoke('bookings', {
                    body: { action: 'test' }
                });

                statusEl.textContent = 'âœ“ Functions deployed';
                statusEl.className = 'status success';
                resultEl.textContent = JSON.stringify({
                    message: 'Edge functions are accessible',
                    note: 'Full payment test requires valid PayMob credentials'
                }, null, 2);
            } catch (err) {
                statusEl.textContent = 'âš  Check deployment';
                statusEl.className = 'status error';
                resultEl.textContent = 'Error: ' + err.message + '\n\nTip: Deploy functions with: supabase functions deploy';
            }
        }

        // Auto-run basic tests on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (SUPABASE_URL && SUPABASE_URL !== 'https://your-project-id.supabase.co') {
                    testSupabase();
                } else {
                    document.getElementById('supabase-result').textContent =
                        'Please configure SUPABASE_URL in assets/config.js first';
                }
            }, 500);
        });
    </script>
</body>

</html>